{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Manoj Arimanda - v-marimanda@microsoft.com",
    "comments": "Solution template for OCILogs"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "OCILogs",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "connector1-name": {
      "type": "string",
      "defaultValue": "4814ff7f-91cb-4438-b909-834ed3f0859a"
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic3-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic4-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic5-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic6-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic7-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic8-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic9-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic10-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    }
  },
  "variables": {
    "OracleCloudInfrastructureOCI_workbook": "Oracle Cloud Infrastructure (OCI)_workbook",
    "_OracleCloudInfrastructureOCI_workbook": "[variables('OracleCloudInfrastructureOCI_workbook')]",
    "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
    "_workbook-source": "[variables('workbook-source')]",
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "OCILogs_Parser": "OCILogs_Parser",
    "_OCILogs_Parser": "[variables('OCILogs_Parser')]",
    "OCIDestinationsIn_HuntingQueries": "OCIDestinationsIn_HuntingQueries",
    "_OCIDestinationsIn_HuntingQueries": "[variables('OCIDestinationsIn_HuntingQueries')]",
    "OCIDestinationsOut_HuntingQueries": "OCIDestinationsOut_HuntingQueries",
    "_OCIDestinationsOut_HuntingQueries": "[variables('OCIDestinationsOut_HuntingQueries')]",
    "OCILaunchedInstances_HuntingQueries": "OCILaunchedInstances_HuntingQueries",
    "_OCILaunchedInstances_HuntingQueries": "[variables('OCILaunchedInstances_HuntingQueries')]",
    "OCIUpdateActivities_HuntingQueries": "OCIUpdateActivities_HuntingQueries",
    "_OCIUpdateActivities_HuntingQueries": "[variables('OCIUpdateActivities_HuntingQueries')]",
    "OCIUserDeleteActions_HuntingQueries": "OCIUserDeleteActions_HuntingQueries",
    "_OCIUserDeleteActions_HuntingQueries": "[variables('OCIUserDeleteActions_HuntingQueries')]",
    "OCIUserDeletedUsers_HuntingQueries": "OCIUserDeletedUsers_HuntingQueries",
    "_OCIUserDeletedUsers_HuntingQueries": "[variables('OCIUserDeletedUsers_HuntingQueries')]",
    "OCIUserNewUsers_HuntingQueries": "OCIUserNewUsers_HuntingQueries",
    "_OCIUserNewUsers_HuntingQueries": "[variables('OCIUserNewUsers_HuntingQueries')]",
    "OCIUserSources_HuntingQueries": "OCIUserSources_HuntingQueries",
    "_OCIUserSources_HuntingQueries": "[variables('OCIUserSources_HuntingQueries')]",
    "OCIUserTerminatedInstances_HuntingQueries": "OCIUserTerminatedInstances_HuntingQueries",
    "_OCIUserTerminatedInstances_HuntingQueries": "[variables('OCIUserTerminatedInstances_HuntingQueries')]",
    "OCIUserUpdatedInstances_HuntingQueries": "OCIUserUpdatedInstances_HuntingQueries",
    "_OCIUserUpdatedInstances_HuntingQueries": "[variables('OCIUserUpdatedInstances_HuntingQueries')]",
    "connector1-source": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',parameters('connector1-name'))]",
    "_connector1-source": "[variables('connector1-source')]",
    "OracleCloudInfrastructureLogsConnectorConnector": "OracleCloudInfrastructureLogsConnectorConnector",
    "_OracleCloudInfrastructureLogsConnectorConnector": "[variables('OracleCloudInfrastructureLogsConnectorConnector')]",
    "OCIDiscoveryActivity_AnalyticalRules": "OCIDiscoveryActivity_AnalyticalRules",
    "_OCIDiscoveryActivity_AnalyticalRules": "[variables('OCIDiscoveryActivity_AnalyticalRules')]",
    "OCIEventRuleDeleted_AnalyticalRules": "OCIEventRuleDeleted_AnalyticalRules",
    "_OCIEventRuleDeleted_AnalyticalRules": "[variables('OCIEventRuleDeleted_AnalyticalRules')]",
    "OCIInboundSSHConnection_AnalyticalRules": "OCIInboundSSHConnection_AnalyticalRules",
    "_OCIInboundSSHConnection_AnalyticalRules": "[variables('OCIInboundSSHConnection_AnalyticalRules')]",
    "OCIInsecureMetadataEndpoint_AnalyticalRules": "OCIInsecureMetadataEndpoint_AnalyticalRules",
    "_OCIInsecureMetadataEndpoint_AnalyticalRules": "[variables('OCIInsecureMetadataEndpoint_AnalyticalRules')]",
    "OCIMetadataEndpointIpAccess_AnalyticalRules": "OCIMetadataEndpointIpAccess_AnalyticalRules",
    "_OCIMetadataEndpointIpAccess_AnalyticalRules": "[variables('OCIMetadataEndpointIpAccess_AnalyticalRules')]",
    "OCIMultipleInstancesLaunched_AnalyticalRules": "OCIMultipleInstancesLaunched_AnalyticalRules",
    "_OCIMultipleInstancesLaunched_AnalyticalRules": "[variables('OCIMultipleInstancesLaunched_AnalyticalRules')]",
    "OCIMultipleInstancesTerminated_AnalyticalRules": "OCIMultipleInstancesTerminated_AnalyticalRules",
    "_OCIMultipleInstancesTerminated_AnalyticalRules": "[variables('OCIMultipleInstancesTerminated_AnalyticalRules')]",
    "OCIMultipleRejects_AnalyticalRules": "OCIMultipleRejects_AnalyticalRules",
    "_OCIMultipleRejects_AnalyticalRules": "[variables('OCIMultipleRejects_AnalyticalRules')]",
    "OCISSHScan_AnalyticalRules": "OCISSHScan_AnalyticalRules",
    "_OCISSHScan_AnalyticalRules": "[variables('OCISSHScan_AnalyticalRules')]",
    "OCIUnexpectedUserAgent_AnalyticalRules": "OCIUnexpectedUserAgent_AnalyticalRules",
    "_OCIUnexpectedUserAgent_AnalyticalRules": "[variables('OCIUnexpectedUserAgent_AnalyticalRules')]",
    "sourceId": "azuresentinel.azure-sentinel-solution-ocilogs",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "2020-02-12",
      "properties": {
        "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**NOTE**: This data connector depends on a parser based on Kusto Function **OCILogs** to work as expected. [Follow steps to get this Kusto Function](https://aka.ms/sentinel-oci-parser)\"},\"name\":\"text - 8\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"cd8447d9-b096-4673-92d8-2a1e8291a125\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"description\":\"Sets the time name for analysis\",\"value\":{\"durationMs\":7776000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":86400000},{\"durationMs\":604800000},{\"durationMs\":2592000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OCILogs\\r\\n| make-series TotalEvents = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Events Over Time\",\"color\":\"magenta\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"graphSettings\":{\"type\":0}},\"customWidth\":\"60\",\"name\":\"query - 12\",\"styleSettings\":{\"maxWidth\":\"55\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let users = OCILogs\\r\\n| where isnotempty(data_definedTags_Oracle_Tags_CreatedBy_s)\\r\\n| summarize i = dcount(data_definedTags_Oracle_Tags_CreatedBy_s)\\r\\n| extend t = 'Total users';\\r\\nlet inst = OCILogs\\r\\n| where isnotempty(data_stateChange_current_Instance_displayName_s)\\r\\n| summarize i = dcount(data_stateChange_current_Instance_displayName_s)\\r\\n| extend t = 'Total instances';\\r\\nlet ip = OCILogs\\r\\n| where ipv4_is_private(DstIpAddr)\\r\\n| summarize i = dcount(DstIpAddr)\\r\\n| extend t = 'Total IP addresses';\\r\\nunion isfuzzy=true users, inst, ip\\r\\n\\r\\n\",\"size\":3,\"title\":\"Environment Summary\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"t\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"i\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"textSettings\":{\"style\":\"bignumber\"}},\"customWidth\":\"40\",\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10\",\"padding\":\"10\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OCILogs\\r\\n| summarize count() by EventType\\r\\n\\r\\n\",\"size\":3,\"title\":\"Event Types\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"URL Category\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"purple\"}},\"showBorder\":false}},\"customWidth\":\"35\",\"name\":\"query - 0\",\"styleSettings\":{\"maxWidth\":\"30\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OCILogs\\n| where isnotempty(SrcIpAddr)\\n| summarize count() by SrcIpAddr\",\"size\":3,\"title\":\"Source IP Addresses\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OCILogs\\n| where isnotempty(DstIpAddr)\\n| summarize count() by DstIpAddr\",\"size\":3,\"title\":\"Destination IP Addresses\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"35\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OCILogs\\n| where data_eventName_s in~ ('LaunchInstance', 'TerminateInstance')\\n| project TimeGenerated, InstanceIP = DstIpAddr, Action = strcat(iif(data_eventName_s =~ 'LaunchInstance', '✅ - Launched', '❌ - Terminated'))\",\"size\":0,\"title\":\"Instance Status\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"User\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"TotalMailsReceived\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"magenta\"}},\"showBorder\":false}},\"customWidth\":\"55\",\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OCILogs\\r\\n| where data_eventName_s =~ 'InteractiveLogin'\\r\\n| project TimeGenerated, SourceAddress = SrcIpAddr, User = data_stateChange_current_userName_s\",\"size\":3,\"title\":\"User sessions\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total Bytes (KB)\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"}}]}},\"customWidth\":\"45\",\"name\":\"query - 2\"}],\"fromTemplateId\":\"sentinel-OCIWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
        "version": "1.0",
        "sourceId": "[variables('_workbook-source')]",
        "category": "sentinel"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OCILogs Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OCILogs Data Parser",
            "category": "Samples",
            "functionAlias": "OCILogs",
            "query": "\nOCI_Logs_CL\r\n| extend EventVendor = 'Oracle'\r\n| extend EventProduct = 'Oracle Cloud Infrastructure'\r\n| extend EventStartTime = iff(isnull(data_startTime_d), time_t, unixtime_seconds_todatetime(data_startTime_d))\r\n| extend EventEndTime = iff(isnull(data_endTime_d), time_t, unixtime_seconds_todatetime(data_endTime_d))\r\n| project-rename EventType=type_s\r\n| extend SrcIpAddr=iff(isnotempty(data_sourceAddress_s), data_sourceAddress_s, data_identity_ipAddress_s)\r\n| project-rename SrcPortNumber=data_sourcePort_d\r\n| project-rename DstIpAddr=data_destinationAddress_s\r\n| project-rename DstPortNumber=data_destinationPort_d\r\n| project-rename DstBytes=data_bytesOut_d\r\n| project-rename NetworkProtocol=data_protocolName_s\r\n| project-rename EventMessage=data_message_s\r\n| project-rename HttpUserAgentOriginal=data_identity_userAgent_s\r\n| project-rename HttpStatusCode=data_response_status_s\r\n| project-rename HttpRequestMethod=data_request_action_s\r\n",
            "version": 1
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OCILogs Hunting Query 1",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OCI - Destination ports (inbound traffic)",
            "category": "Hunting Queries",
            "query": "OCILogs\n| where TimeGenerated > ago(24h)\n| where EventType contains 'vcn.flowlogs'\n| where data_action_s =~ 'ACCEPT'\n| where ipv4_is_private(DstIpAddr)\n| where ipv4_is_private(SrcIpAddr) == False\n| summarize count() by DstIpAddr, DstPortNumber\n| extend IPCustomEntity = DstIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for destination ports of inbound traffic."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OCILogs Hunting Query 2",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OCI - Destination ports (outbound traffic)",
            "category": "Hunting Queries",
            "query": "OCILogs\n| where TimeGenerated > ago(24h)\n| where EventType contains 'vcn.flowlogs'\n| where data_action_s =~ 'ACCEPT'\n| where ipv4_is_private(SrcIpAddr)\n| where ipv4_is_private(DstIpAddr) == False\n| summarize count() by SrcIpAddr, DstIpAddr, DstPortNumber\n| extend IPCustomEntity = data_sourceAddress_s\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for destination ports of outbound traffic."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OCILogs Hunting Query 3",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OCI - Launched instances",
            "category": "Hunting Queries",
            "query": "OCILogs\n| where TimeGenerated > ago(24h)\n| where EventType endswith 'LaunchInstance'\n| extend AccountCustomEntity = data_definedTags_Oracle_Tags_CreatedBy_s\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for new launched instances."
              },
              {
                "name": "tactics",
                "value": "Impact"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OCILogs Hunting Query 4",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OCI - Update activities",
            "category": "Hunting Queries",
            "query": "OCILogs\n| where TimeGenerated > ago(24h)\n| where data_eventName_s startswith 'Update'\n| project TimeGenerated, data_eventName_s, data_definedTags_Oracle_Tags_CreatedBy_s\n| extend AccountCustomEntity = data_definedTags_Oracle_Tags_CreatedBy_s\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for update activities performed by users."
              },
              {
                "name": "tactics",
                "value": "Impact"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OCILogs Hunting Query 5",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OCI - Delete operations",
            "category": "Hunting Queries",
            "query": "OCILogs\n| where TimeGenerated > ago(24h)\n| where data_eventName_s startswith 'Delete'\n| extend AccountCustomEntity = data_definedTags_Oracle_Tags_CreatedBy_s\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for delete operations performed by user."
              },
              {
                "name": "tactics",
                "value": "Impact"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OCILogs Hunting Query 6",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OCI - Deleted users",
            "category": "Hunting Queries",
            "query": "OCILogs\n| where TimeGenerated > ago(24h)\n| where data_eventName_s =~ 'DeleteUser'\n| extend AccountCustomEntity = data_definedTags_Oracle_Tags_CreatedBy_s\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for users being deleted."
              },
              {
                "name": "tactics",
                "value": "Impact"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OCILogs Hunting Query 7",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OCI - New users",
            "category": "Hunting Queries",
            "query": "OCILogs\n| where TimeGenerated > ago(24h)\n| where data_eventName_s =~ 'CreateUser'\n| extend AccountCustomEntity = data_definedTags_Oracle_Tags_CreatedBy_s\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for new users created."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,Persistence"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OCILogs Hunting Query 8",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OCI - User source IP addresses",
            "category": "Hunting Queries",
            "query": "OCILogs\n| where TimeGenerated > ago(24h)\n| where data_eventName_s startswith 'InteractiveLogin'\n| summarize makeset(SrcIpAddr) by data_definedTags_Oracle_Tags_CreatedBy_s\n| extend AccountCustomEntity = data_definedTags_Oracle_Tags_CreatedBy_s\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for user source IP addresses."
              },
              {
                "name": "tactics",
                "value": "Impact"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OCILogs Hunting Query 9",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OCI - Terminated instances",
            "category": "Hunting Queries",
            "query": "OCILogs\n| where TimeGenerated > ago(24h)\n| where data_eventName_s =~ 'TerminateInstance'\n| extend AccountCustomEntity = data_definedTags_Oracle_Tags_CreatedBy_s\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for terminated instances."
              },
              {
                "name": "tactics",
                "value": "Impact"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OCILogs Hunting Query 10",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OCI - Updated instances",
            "category": "Hunting Queries",
            "query": "OCILogs\n| where TimeGenerated > ago(24h)\n| where data_eventName_s =~ 'UpdateInstance'\n| extend AccountCustomEntity = data_definedTags_Oracle_Tags_CreatedBy_s\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for updated instances."
              },
              {
                "name": "tactics",
                "value": "DefenseEvasion"
              }
            ]
          }
        }
      ]
    },
    {
      "id": "[variables('_connector1-source')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connector1-name'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Oracle Cloud Infrastructure",
          "publisher": "Oracle",
          "descriptionMarkdown": "The Oracle Cloud Infrastructure (OCI) data connector provides the capability to ingest OCI Logs from [OCI Stream](https://docs.oracle.com/iaas/Content/Streaming/Concepts/streamingoverview.htm) into Azure Sentinel using the [OCI Streaming REST API](https://docs.oracle.com/iaas/api/#/streaming/streaming/20180418).",
          "graphQueries": [
            {
              "metricName": "OCI Events",
              "legend": "OCI_Logs_CL",
              "baseQuery": "OCI_Logs_CL"
            }
          ],
          "sampleQueries": [
            {
              "description": "All OCI Events",
              "query": "OCI_Logs_CL\n| sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "OCI_Logs_CL",
              "lastDataReceivedQuery": "OCI_Logs_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "OCI_Logs_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(1d)"
              ]
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "OCI API Credentials",
                "description": " **API Key Configuration File** and **Private Key** are required for OCI API connection. See the documentation to learn more about [creating keys for API access](https://docs.oracle.com/en-us/iaas/Content/API/Concepts/apisigningkey.htm)"
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to the Azure Blob Storage API to pull logs into Azure Sentinel. This might result in additional costs for data ingestion and for storing data in Azure Blob Storage costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) and [Azure Blob Storage pricing page](https://azure.microsoft.com/pricing/details/storage/blobs/) for details."
            },
            {
              "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
            },
            {
              "description": ">**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected [**OCILogs**](https://aka.ms/sentinel-OracleCloudInfrastructureLogsConnector-parser) which is deployed with the Azure Sentinel Solution."
            },
            {
              "description": "**STEP 1 - Creating Stream**\n\n1. Log in to OCI console and go to *navigation menu* -> *Analytics & AI* -> *Streaming*\n2. Click *Create Stream*\n3. Select Stream Pool or create a new one\n4. Provide the *Stream Name*, *Retention*, *Number of Partitions*, *Total Write Rate*, *Total Read Rate* based on your data amount.\n5. Go to *navigation menu* -> *Logging* -> *Service Connectors*\n6. Click *Create Service Connector*\n6. Provide *Connector Name*, *Description*, *Resource Compartment*\n7. Select Source: Logging\n8. Select Target: Streaming\n9. (Optional) Configure *Log Group*, *Filters* or use custom search query to stream only logs that you need.\n10. Configure Target - select the strem created before.\n11. Click *Create*\n\nCheck the documentation to get more information about [Streaming](https://docs.oracle.com/en-us/iaas/Content/Streaming/home.htm) and [Service Connectors](https://docs.oracle.com/en-us/iaas/Content/service-connector-hub/home.htm)."
            },
            {
              "description": "**STEP 2 - Creating credentials for OCI REST API**\n\nFollow the documentation to [create Private Key and API Key Configuration File.](https://docs.oracle.com/en-us/iaas/Content/API/Concepts/apisigningkey.htm)\n\n>**IMPORTANT:** Save Private Key and API Key Configuration File created during this step as they will be used during deployment step."
            },
            {
              "description": "**STEP 3 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the OCI data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following), as well as OCI API credentials, readily available.",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "fillWith": [
                      "PrimaryKey"
                    ],
                    "label": "Primary Key"
                  },
                  "type": "CopyableLabel"
                }
              ]
            },
            {
              "description": "Use this method for automated deployment of the OCI data connector using an ARM Template.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-OracleCloudInfrastructureLogsConnector-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n3. Enter the **Azure Sentinel Workspace Id**, **Azure Sentinel Shared Key**, **User**, **Key_content**, **Pass_phrase**, **Fingerprint**, **Tenancy**, **Region**, **Message Endpoint**, **Stream Ocid**\n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**.\n5. Click **Purchase** to deploy.",
              "title": "Option 1 - Azure Resource Manager (ARM) Template"
            },
            {
              "description": "Use the following step-by-step instructions to deploy the OCI data connector manually with Azure Functions (Deployment via Visual Studio Code).",
              "title": "Option 2 - Manual Deployment of Azure Functions"
            },
            {
              "description": "**1. Deploy a Function App**\n\n> **NOTE:** You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/create-first-function-vs-code-python) for Azure function development.\n\n1. Download the [Azure Function App](https://aka.ms/sentinel-OracleCloudInfrastructureLogsConnector-functionapp) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. OciAuditXX).\n\n\te. **Select a runtime:** Choose Python 3.8.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Azure Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
            },
            {
              "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select **+ New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tAzureSentinelWorkspaceId\n\t\tAzureSentinelSharedKey\n\t\tuser\n\t\tkey_content\n\t\tpass_phrase (Optional)\n\t\tfingerprint\n\t\ttenancy\n\t\tregion\n\t\tMessage Endpoint\n\t\tStreamOcid\n\t\tlogAnalyticsUri (Optional)\n - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://WORKSPACE_ID.ods.opinsights.azure.us`. \n4. Once all application settings have been entered, click **Save**."
            }
          ],
          "additionalRequirementBanner": "This data connector depends on a parser based on a Kusto Function to work as expected [**OCILogs**](https://aka.ms/sentinel-OracleCloudInfrastructureLogsConnector-parser) which is deployed with the Azure Sentinel Solution."
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects possible discovery activity.",
        "displayName": "OCI - Discovery activity",
        "enabled": false,
        "query": "let threshold = 20;\nOCILogs\n| where data_eventName_s startswith 'List' or data_eventName_s startswith 'Get'\n| summarize count() by data_definedTags_Oracle_Tags_CreatedBy_s, bin(TimeGenerated, 10m)\n| where count_ > threshold\n| extend AccountCustomEntity = data_definedTags_Oracle_Tags_CreatedBy_s\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Discovery"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "columnName": "AccountCustomEntity",
                "identifier": "Name"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when event rule was deleted.",
        "displayName": "OCI - Event rule deleted",
        "enabled": false,
        "query": "OCILogs\n| where data_eventName_s =~ 'DeleteRule'\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic3-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects inbound SSH connection.",
        "displayName": "OCI - Inbound SSH connection",
        "enabled": false,
        "query": "OCILogs\n| where EventType contains 'vcn.flowlogs'\n| where data_action_s =~ 'ACCEPT'\n| where ipv4_is_private(DstIpAddr)\n| where ipv4_is_private(SrcIpAddr) == False\n| where DstPortNumber == 22\n| extend IPCustomEntity = DstIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic4-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects insecure metadata endpoint.",
        "displayName": "OCI - Insecure metadata endpoint",
        "enabled": false,
        "query": "OCILogs\n| where data_request_headers_oci_original_url_s contains '/opc/v1' or data_request_headers_oci_original_url_s contains '/openstack'\n| where HttpStatusCode == 200\n| extend IPCustomEntity = DstIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Discovery"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic5-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects instance metadata access.",
        "displayName": "OCI - Instance metadata access",
        "enabled": false,
        "query": "OCILogs\n| where EventType contains 'vcn.flowlogs'\n| where data_action_s =~ 'ACCEPT'\n| where DstIpAddr == '169.254.169.254'\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Discovery"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic6-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when multiple instances were launched.",
        "displayName": "OCI - Multiple instances launched",
        "enabled": false,
        "query": "let threshold = 5;\nOCILogs\n| where data_eventName_s =~ 'LaunchInstance'\n| summarize count() by SrcIpAddr, bin(TimeGenerated, 10m)\n| where count_ >= threshold\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Impact"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic7-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when multiple instances were terminated.",
        "displayName": "OCI - Multiple instances terminated",
        "enabled": false,
        "query": "let threshold = 5;\nOCILogs\n| where data_eventName_s =~ 'TerminateInstance'\n| summarize count() by SrcIpAddr, bin(TimeGenerated, 10m)\n| where count_ >= threshold\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Impact"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic8-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects multiple rejects on rare ports.",
        "displayName": "OCI - Multiple rejects on rare ports",
        "enabled": false,
        "query": "let threshold = 50;\nlet r_dports = \nOCILogs\n| where EventType contains 'vcn.flowlogs'\n| where ipv4_is_private(DstIpAddr)\n| where ipv4_is_private(SrcIpAddr) == False\n| summarize count() by DstPortNumber\n| top 10 by count_ asc\n| summarize dports = makeset(DstPortNumber)\n| extend k = 1;\nOCILogs\n| where EventType contains 'vcn.flowlogs'\n| where data_action_s =~ 'REJECT'\n| where ipv4_is_private(DstIpAddr)\n| where ipv4_is_private(SrcIpAddr) == False\n| extend k = 1\n| join kind=innerunique (r_dports) on k\n| where dports has tostring(DstPortNumber)\n| summarize count() by SrcIpAddr, bin(TimeGenerated, 5m)\n| where count_ > threshold\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "P14D",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Reconnaissance"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic9-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects possible SSH scanning activity.",
        "displayName": "OCI - SSH scanner",
        "enabled": false,
        "query": "let threshold = 5;\nOCILogs\n| where EventType contains 'vcn.flowlogs'\n| where data_action_s =~ 'REJECT'\n| where ipv4_is_private(DstIpAddr)\n| where ipv4_is_private(SrcIpAddr) == False\n| where DstPortNumber == 22\n| summarize p_count = dcount(DstIpAddr) by SrcIpAddr, bin(TimeGenerated, 5m)\n| where p_count > threshold\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "P14D",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Reconnaissance"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic10-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects unexpected user agent strings.",
        "displayName": "OCI - Unexpected user agent",
        "enabled": false,
        "query": "OCILogs\n| where isnotempty(HttpUserAgentOriginal)\n| where strlen(HttpUserAgentOriginal) <= 10\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "entityType": "IP",
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "version": "1.0.2",
        "kind": "Solution",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "OCILogs",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Manoj Arimanda",
          "email": "v-marimanda@microsoft.com"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_OracleCloudInfrastructureOCI_workbook')]",
              "version": "1.0.2"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_OCILogs_Parser')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OCIDestinationsIn_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OCIDestinationsOut_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OCILaunchedInstances_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OCIUpdateActivities_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OCIUserDeleteActions_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OCIUserDeletedUsers_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OCIUserNewUsers_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OCIUserSources_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OCIUserTerminatedInstances_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OCIUserUpdatedInstances_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_OracleCloudInfrastructureLogsConnectorConnector')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OCIDiscoveryActivity_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OCIEventRuleDeleted_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OCIInboundSSHConnection_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OCIInsecureMetadataEndpoint_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OCIMetadataEndpointIpAccess_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OCIMultipleInstancesLaunched_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OCIMultipleInstancesTerminated_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OCIMultipleRejects_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OCISSHScan_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OCIUnexpectedUserAgent_AnalyticalRules')]",
              "version": "1.0.2"
            }
          ]
        },
        "firstPublishDate": "2021-09-28",
        "providers": [
          "Oracle"
        ],
        "categories": {
          "domains": [
            "Cloud Provider"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
