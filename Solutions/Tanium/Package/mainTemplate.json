{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Tanium - support@tanium.com",
    "comments": "Solution template for Tanium"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Tanium",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "playbook1-PlaybookName": {
      "defaultValue": "Tanium-GeneralHostInfo",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook1-IntegrationAccountName": {
      "defaultValue": "Tanium-GeneralHostInfo-Integration",
      "type": "string",
      "minLength": 1
    },
    "playbook1-IntegrationAccountPricingTier": {
      "defaultValue": "Free",
      "type": "string",
      "minLength": 1
    },
    "playbook1-TaniumApiToken": {
      "defaultValue": "",
      "type": "string",
      "minLength": 1
    },
    "playbook1-TaniumServerHostname": {
      "defaultValue": "hostname",
      "type": "string",
      "minLength": 1
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "connector1-name": {
      "type": "string",
      "defaultValue": "7122fe94-daa7-49b2-bb92-5f7decce2880"
    }
  },
  "variables": {
    "TaniumWorkbook_workbook": "TaniumWorkbook_workbook",
    "_TaniumWorkbook_workbook": "[variables('TaniumWorkbook_workbook')]",
    "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
    "_workbook-source": "[variables('workbook-source')]",
    "playbook1-Tanium-GeneralHostInfo": "playbook1-Tanium-GeneralHostInfo",
    "_playbook1-Tanium-GeneralHostInfo": "[variables('playbook1-Tanium-GeneralHostInfo')]",
    "playbook1-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook1-PlaybookName'))]",
    "playbook1-TaniumApiGatewayApi": "[uri(concat('https://',parameters('playbook1-TaniumServerHostname')),'/plugin/products/gateway/graphql')]",
    "playbook-1-connection-1": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]",
    "_playbook-1-connection-1": "[variables('playbook-1-connection-1')]",
    "TaniumThreatResponseAlerts_AnalyticalRules": "TaniumThreatResponseAlerts_AnalyticalRules",
    "_TaniumThreatResponseAlerts_AnalyticalRules": "[variables('TaniumThreatResponseAlerts_AnalyticalRules')]",
    "connector1-source": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',parameters('connector1-name'))]",
    "_connector1-source": "[variables('connector1-source')]",
    "TaniumConnectorConnector": "TaniumConnectorConnector",
    "_TaniumConnectorConnector": "[variables('TaniumConnectorConnector')]",
    "sourceId": "taniuminc1646329360287.azure-sentinel-solution-tanium",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "2021-08-01",
      "properties": {
        "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"885a9b5d-b2d6-4316-a6f9-6f65941b55b8\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Threat Response\",\"subTarget\":\"Threat Response\",\"style\":\"link\"},{\"id\":\"786ffe19-a17d-4ca9-9355-f97406ae048f\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Comply\",\"subTarget\":\"Comply\",\"preText\":\"Comply\",\"style\":\"link\"},{\"id\":\"efd238ee-2305-4384-a38c-a96d850ab4c9\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Discover\",\"subTarget\":\"Discover\",\"style\":\"link\"},{\"id\":\"a34745a8-6073-484d-adc5-d5c8e7fb9209\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Microsoft Tooling Health\",\"subTarget\":\"Microsoft Tooling Health\",\"style\":\"link\"},{\"id\":\"32a1a85f-978f-4b42-b27f-41cfb90e4e14\",\"cellValue\":\"selectedTab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Patch\",\"subTarget\":\"Patch\",\"style\":\"link\"}]},\"name\":\"links - 8\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Top mission critical computers with CVSS hits >= 9.0\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumComplyVulnerabilities_CL \\n| join TaniumMainAsset_CL on Computer_Name_s| where CVSS_Score_s startswith \\\"9\\\"\\n| extend Host_0_HostName = Computer_Name_s\\n| extend Malware_0_Name = CVE_s\\n| extend IP_0_Address = IP_Address_s\\n| summarize count() by Computer_Name_s | limit 4\\n| sort by count_\\n\",\"size\":4,\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Computer_Name_s\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Computer_Name_s\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"count_\",\"heatmapPalette\":\"greenRed\"}}},\"name\":\"query - 2\"},{\"type\":1,\"content\":{\"json\":\"## Top operating systems with CVSS hits >= 9.0\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumComplyVulnerabilities_CL \\n| join TaniumMainAsset_CL on Computer_Name_s| where CVSS_Score_s startswith \\\"9\\\"\\n| extend Host_0_HostName = Computer_Name_s\\n| extend Malware_0_Name = CVE_s\\n| extend IP_0_Address = IP_Address_s\\n| summarize count() by Operating_System_Generation_s\\n| sort by count_\",\"size\":4,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Operating_System_Generation_s\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"showBorder\":false}},\"name\":\"query - 3\"},{\"type\":1,\"content\":{\"json\":\"## Vulnerability distribution by year\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumComplyVulnerabilities_CL\\n|distinct CVE_Year_s,Computer_Name_s, CVE_s\\n|summarize count() by CVE_Year_s\\n|render barchart  \\n|sort by CVE_Year_s asc\",\"size\":0,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 3\"},{\"type\":1,\"content\":{\"json\":\"## Vulnerability Distribution by OS\"},\"name\":\"text - 5\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumComplyVulnerabilities_CL\\n|distinct CVE_s, Computer_Name_s, Operating_System_Generation_s\\n|summarize count() by Operating_System_Generation_s\\n|render barchart\",\"size\":0,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 4\"},{\"type\":1,\"content\":{\"json\":\"## Vulnerability Distribution by Severity\"},\"name\":\"text - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumComplyVulnerabilities_CL\\n|distinct CVE_s,Severity_s\\n|summarize count() by Severity_s\",\"size\":0,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"graph\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Severity_s\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":2,\"topContent\":{\"columnMatch\":\"Severity_s\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"count_\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"nodeIdField\":\"Severity_s\",\"graphOrientation\":3,\"showOrientationToggles\":false,\"staticNodeSize\":100,\"hivesMargin\":5},\"textSettings\":{\"style\":\"bignumber\"}},\"name\":\"query - 7\"},{\"type\":1,\"content\":{\"json\":\"## System Outliers (Based on CVE Count & Aggregate CVSS Score)\\n\"},\"name\":\"text - 14\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumComplyVulnerabilities_CL\\n|join kind=inner TaniumMainAsset_CL on Computer_Name_s\\n|distinct CVE_s,Computer_Name_s,CVSS_Score_s, Operating_System_Generation_s\\n|summarize  CVECount=dcount(CVE_s), cvss_endpoint_score=sum(todecimal(CVSS_Score_s)) by Computer_Name_s, Operating_System_Generation_s\\n|project cvss_endpoint_score, CVECount, Computer_Name_s, Operating_System_Generation_s\\n|render scatterchart\\n|sort by cvss_endpoint_score asc\",\"size\":0,\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"scatterchart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Computer_Name_s\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"cvss_endpoint_score\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"Computer_Name_s\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"cvss_endpoint_score\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"xAxis\":\"cvss_endpoint_score\",\"yAxis\":[\"CVECount\"],\"showLegend\":true,\"customThresholdLine\":\"{cvecount}\",\"customThresholdLineStyle\":5},\"mapSettings\":{\"locInfo\":\"LatLong\",\"sizeSettings\":\"cvss_endpoint_score\",\"sizeAggregation\":\"Sum\",\"legendMetric\":\"cvss_endpoint_score\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"type\":\"heatmap\",\"colorAggregation\":\"Sum\",\"nodeColorField\":\"cvss_endpoint_score\",\"heatmapPalette\":\"greenRed\"}}},\"name\":\"query - 15\"},{\"type\":1,\"content\":{\"json\":\"## Compliance Benchmark - Pass Rate\"},\"name\":\"text - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumComplyCompliance_CL | where  Rule_ID_s <> \\\"\\\"\\n|summarize  Total=count(), Pass=countif(Status_Category_s has \\\"Pass\\\"), Fail=countif(Status_Category_s has \\\"Fail\\\")\\n|extend PassRate=(Pass*1.0/Total)*100\\n|project PassRate\",\"size\":1,\"timeContext\":{\"durationMs\":604800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"PassRate\",\"formatter\":12,\"formatOptions\":{\"palette\":\"redBright\"}},\"showBorder\":false}},\"name\":\"query - 11\"},{\"type\":1,\"content\":{\"json\":\"## Top 10 Benchmark Failures\"},\"name\":\"text - 12\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumComplyCompliance_CL \\n|where  Rule_ID_s <> \\\"\\\" and Status_Category_s has \\\"fail\\\"\\n|summarize Count=count() by RuleID=Rule_ID_s\\n|top 10 by Count\",\"size\":0,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 13\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Comply\"},\"customWidth\":\"100\",\"name\":\"cvss_group\",\"styleSettings\":{\"maxWidth\":\"100\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Unmanaged OS Platform\\n\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumDiscoverUnmanagedAssets_CL\\n|where Os_s <> \\\"\\\" \\n|distinct MacAddress_s,Os_s\\n|summarize count() by Os_s\\n\",\"size\":0,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"name\":\"query - 1\"},{\"type\":1,\"content\":{\"json\":\"## Unmanaged Device Type\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumDiscoverUnmanagedAssets_CL\\n|where MacOrganization_s <> \\\"\\\" \\n|distinct MacAddress_s,MacOrganization_s\\n|summarize count() by MacOrganization_s\",\"size\":0,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"name\":\"query - 3\"},{\"type\":1,\"content\":{\"json\":\"## Unmanaged Open Ports\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumDiscoverUnmanagedAssets_CL\\n|where Ports_s <> \\\"\\\" \\n|distinct MacAddress_s,Ports_s\\n|summarize count() by Ports_s\\n\\n\",\"size\":0,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"name\":\"query - 5\"},{\"type\":1,\"content\":{\"json\":\"## All Unmanaged Assets\"},\"name\":\"text - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumDiscoverUnmanagedAssets_CL\\n| where HostName_s <> \\\"\\\"\\n| project Hostname=HostName_s, MacAddres=MacAddress_s, IPAddress, MacOrganization=MacOrganization_s, LastDiscoveredTime=LastDiscoveredAt_s\\n| sort by LastDiscoveredTime\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 7\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Discover\"},\"name\":\"discover_group\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"MIcrosoft Tooling Health \",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Defender AV Status\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumDefenderHealth_CL\\n|where Antivirus_State_s <> \\\"\\\"\\n|summarize count () by Antivirus_State_s\\n|project Antivirus_State=Antivirus_State_s, Count=count_\\n|render piechart    \\n\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":1,\"content\":{\"json\":\"## Defender AV Process Status\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumDefenderHealth_CL\\n|where Defender_Process_s <> \\\"\\\"\\n|summarize count () by Defender_Process_s\\n|project Defender_Process_Status=Defender_Process_s, Count=count_\\n|render piechart    \\n\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 3\"},{\"type\":1,\"content\":{\"json\":\"## Defender AV Signature Update Age\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumDefenderHealth_CL\\n|where Signature_Update_Age_s <> \\\"\\\"\\n|summarize count () by Signature_Update_Age=Signature_Update_Age_s\\n|project Signature_Update_Age=Signature_Update_Age, Count=count_\\n|render columnchart    \",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 5\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Microsoft Tooling Health\"},\"customWidth\":\"50\",\"name\":\"group - 5\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"MEMCM Health\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## MEMCM Health Status\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumSCCMClientHealth_CL\\n|where Health_Status_s !has \\\"N/A\\\"\\n|project Computer_Name=Computer_Name_s,Health_Status=Health_Status_s, Reason=Reason_s\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 1\"},{\"type\":1,\"content\":{\"json\":\"## MEMCM Health Issues\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumSCCMClientHealth_CL\\n|where Reason_s <> \\\"\\\"\\n|summarize count() by Reason_s\\n|project Health_Status=Reason_s,Count=count_\\n|render piechart\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 3\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Microsoft Tooling Health\"},\"customWidth\":\"50\",\"name\":\"sccm_group\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Intel Names over time\"},\"name\":\"text - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumThreatResponse_CL\\n|project Computer_Name_s,Timestamp_t,Intel_Name_s\\n|summarize count () by Timestamp_t, Intel_Name_s\\n|render areachart\",\"size\":0,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 0\"},{\"type\":1,\"content\":{\"json\":\"## Threat Response Alert Types\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumThreatResponse_CL\\n| summarize count() by Intel_Type_s\\n| render piechart  \",\"size\":0,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 3\"},{\"type\":1,\"content\":{\"json\":\"## THR Alert by User\\n\"},\"name\":\"text - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumThreatResponse_CL\\n| summarize count() by Match_Details_match_properties_user_s\\n| render piechart  \",\"size\":0,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 5\"},{\"type\":1,\"content\":{\"json\":\"## Threat Response Alerts by Process Name\"},\"name\":\"text - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumThreatResponse_CL\\n| where isnotempty(Match_Details_match_properties_name_s)\\n| extend ActingProcessName = Match_Details_match_properties_name_s\\n| summarize event_count=count() by bin(Timestamp_t, 7d), ActingProcessName\\n| top 20 by event_count\\n| render barchart\",\"size\":0,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 7\"},{\"type\":1,\"content\":{\"json\":\"## All Alerts by Computer Name\"},\"name\":\"text - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumThreatResponse_CL\\n|summarize count() by Computer_Name_s, Intel_Name_s\\n|project-rename Computer_Name=Computer_Name_s, Intel_Name=Intel_Name_s, Count=count_\\n|sort by Count\",\"size\":0,\"timeContext\":{\"durationMs\":2592000000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 9\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Threat Response\"},\"name\":\"Threat Response\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Reboot Required\"},\"name\":\"text - 0\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumHighUptime_CL\\n|project TimeGenerated, Computer_Name_s,Reboot_Required_s\\n|where Reboot_Required_s contains \\\"Yes\\\"\\n|count\",\"size\":4,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"tileSettings\":{\"showBorder\":false},\"textSettings\":{\"style\":\"bignumber\"}},\"name\":\"query - 1\"},{\"type\":1,\"content\":{\"json\":\"## Endpoints with High Uptime (>30 days)\"},\"name\":\"text - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumHighUptime_CL\\n|where High_Uptime_s !in (\\\"Less than 30\\\", \\\"N/A\\\")\\n|extend Days=split(High_Uptime_s,\\\" \\\",0)\\n|project Computer_Name=Computer_Name_s,toint(Days=Days[0])\",\"size\":1,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Computer_Name\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Days\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"graphSettings\":{\"type\":0}},\"name\":\"query - 3\"},{\"type\":1,\"content\":{\"json\":\"## Patch Compliance - All Patches\"},\"name\":\"text - 4\",\"styleSettings\":{\"margin\":\"50\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumPatchListCompliance_CL\\n|where Patch_List_Name_s == \\\"All Patches\\\"\\n|summarize count () by Compliance_Status_s\\n|render piechart \",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 5\"},{\"type\":1,\"content\":{\"json\":\"## Severity of missing Patches\\n\"},\"name\":\"text - 6\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumPatchListApplicability_CL\\n|where Superseded_s has \\\"False\\\" and Install_Status_s has \\\"Not Installed\\\"\\n|summarize count() by Severity_s\\n|render piechart \",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"query - 7\"},{\"type\":1,\"content\":{\"json\":\"## Patch by install status\"},\"name\":\"text - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumPatchListApplicability_CL\\n|where Superseded_s has \\\"false\\\"\\n|summarize count() by Install_Status_s,Severity_s\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"categoricalbar\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"Not Installed\",\"color\":\"red\"},{\"seriesName\":\"Installed\",\"color\":\"green\"}]}},\"name\":\"query - 9\"},{\"type\":1,\"content\":{\"json\":\"## Important/Critical Missing Patches by Year\"},\"name\":\"text - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TaniumPatchListApplicability_CL\\n|distinct Title_s,Install_Status_s,Severity_s,Release_Date_s\\n|where Install_Status_s has \\\"Not Installed\\\"\\n|where Severity_s in (\\\"Critical\\\", \\\"Important\\\")\\n|extend Year=(split(Release_Date_s,\\\"/\\\",2))\\n|summarize count() by Year=tostring(Year[0])\",\"size\":0,\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"categoricalbar\"},\"name\":\"query - 11\"}]},\"conditionalVisibility\":{\"parameterName\":\"selectedTab\",\"comparison\":\"isEqualTo\",\"value\":\"Patch\"},\"name\":\"Patch\"}],\"fromTemplateId\":\"sentinel-TaniumWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\n",
        "version": "1.0",
        "sourceId": "[variables('_workbook-source')]",
        "category": "sentinel"
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook1-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[variables('playbook1-AzureSentinelConnectionName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/integrationAccounts",
      "apiVersion": "2016-06-01",
      "name": "[parameters('playbook1-IntegrationAccountName')]",
      "location": "[parameters('workspace-location')]",
      "sku": {
        "name": "[parameters('playbook1-IntegrationAccountPricingTier')]"
      },
      "properties": {
        "state": "Enabled"
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook1-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook1-AzureSentinelConnectionName'))]",
        "[resourceId('Microsoft.Logic/integrationAccounts', parameters('playbook1-IntegrationAccountName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "integrationAccount": {
          "id": "[resourceId('Microsoft.Logic/integrationAccounts', parameters('playbook1-IntegrationAccountName'))]"
        },
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            },
            "TaniumApiToken": {
              "type": "SecureString",
              "metadata": {
                "description": "The Tanium API Token provides access to the Tanium Server. Access is restricted to the level of access available to the user who generated the token."
              }
            },
            "TaniumApiGatewayApi": {
              "type": "String"
            }
          },
          "triggers": {
            "Microsoft_Sentinel_incident": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              }
            }
          },
          "actions": {
            "Add_comment_to_incident_(V3)_2": {
              "runAfter": {
                "Create_HTML_table": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection",
              "inputs": {
                "body": {
                  "incidentArmId": "@triggerBody()?['object']?['id']",
                  "message": "<p>@{body('Create_HTML_table')}</p>"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/Incidents/Comment"
              }
            },
            "Create_HTML_table": {
              "runAfter": {
                "Flatten_API_Gateway_endpoints": [
                  "Succeeded"
                ]
              },
              "type": "Table",
              "inputs": {
                "format": "HTML",
                "from": "@body('Flatten_API_Gateway_endpoints')"
              }
            },
            "Entities_-_Get_Hosts": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              }
            },
            "Exit_early_if_no_hosts_are_found": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>No hosts found for this incident.</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  }
                },
                "Terminate": {
                  "runAfter": {
                    "Add_comment_to_incident_(V3)": [
                      "Succeeded"
                    ]
                  },
                  "type": "Terminate",
                  "inputs": {
                    "runStatus": "Succeeded"
                  }
                }
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "expression": {
                "and": [
                  {
                    "less": [
                      "@length(body('Entities_-_Get_Hosts')?['Hosts'])",
                      1
                    ]
                  }
                ]
              },
              "type": "If"
            },
            "Flatten_API_Gateway_endpoints": {
              "runAfter": {
                "Parse_endpoints_array": [
                  "Succeeded"
                ]
              },
              "type": "JavaScriptCode",
              "inputs": {
                "code": "var e = workflowContext.actions.Parse_endpoints_array.outputs.body;  function sensorReadings(r) { \treturn r.columns.map(c => { \t\tif (c.sensor && c.sensor.name) { \t\t\treturn { name: [c.sensor.name, c.name].join(' - '), value: c.values.join(' ') }; \t\t} else { \t\t\treturn { name: c.name, value: c.values.join(' ') }; \t\t} \t}); }  function flatten(obj, pk = '') { \tif (pk !== '') pk += ' '; \tlet flat = {}; \tObject.keys(obj).forEach((key) => { \t\tif (key === 'sensorReadings') { \t\t\tsensorReadings(obj[key]).forEach((r) => { \t\t\t\tflat[r.name] = r.value; \t\t\t}); \t\t} else { \t\t\tif (typeof obj[key] === 'object' && obj[key] !== null) { \t\t\t\tObject.assign(flat, flatten(obj[key], pk + key)); \t\t\t} else { \t\t\t\tflat[pk + key] = obj[key]; \t\t\t} \t\t} \t}); \treturn flat; }  return e.map(function(e) { return flatten(e.node); });"
              }
            },
            "For_each_incident_host": {
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "actions": {
                "If_ip_address": {
                  "actions": {
                    "Append_to_endpoint_filters": {
                      "runAfter": {
                        "Compose_endpoint_filter_for_host_and_ip_address": [
                          "Succeeded"
                        ]
                      },
                      "type": "AppendToArrayVariable",
                      "inputs": {
                        "name": "endpoint filters",
                        "value": "@outputs('Compose_endpoint_filter_for_host_and_ip_address')"
                      }
                    },
                    "Compose_endpoint_filter_for_host_and_ip_address": {
                      "type": "Compose",
                      "inputs": {
                        "filters": [
                          {
                            "op": "CONTAINS",
                            "path": "ipAddress",
                            "value": "@{body('Parse_host_json')?['additionalData']?['LastIpAddress']}"
                          },
                          {
                            "path": "name",
                            "value": "@{body('Parse_host_json')?['hostName']}"
                          }
                        ]
                      }
                    }
                  },
                  "runAfter": {
                    "Parse_host_json": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "Append_host_only_to_endpoint_filters": {
                        "runAfter": {
                          "Compose_endpoint_filter_for_host_only": [
                            "Succeeded"
                          ]
                        },
                        "type": "AppendToArrayVariable",
                        "inputs": {
                          "name": "endpoint filters",
                          "value": "@outputs('Compose_endpoint_filter_for_host_only')"
                        }
                      },
                      "Compose_endpoint_filter_for_host_only": {
                        "type": "Compose",
                        "inputs": {
                          "filters": [
                            {
                              "path": "name",
                              "value": "@{body('Parse_host_json')?['hostName']}"
                            }
                          ]
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "not": {
                          "equals": [
                            "@body('Parse_host_json')?['additionalData']?['LastIpAddress']",
                            "@null"
                          ]
                        }
                      }
                    ]
                  },
                  "type": "If"
                },
                "Parse_host_json": {
                  "type": "ParseJson",
                  "inputs": {
                    "content": "@items('For_each_incident_host')",
                    "schema": {
                      "properties": {
                        "Type": {
                          "type": "string"
                        },
                        "additionalData": {
                          "properties": {
                            "AvStatus": {
                              "type": "string"
                            },
                            "FQDN": {
                              "type": "string"
                            },
                            "HealthStatus": {
                              "type": "string"
                            },
                            "LastExternalIpAddress": {
                              "type": "string"
                            },
                            "LastIpAddress": {
                              "type": "string"
                            },
                            "LastSeen": {
                              "type": "string"
                            },
                            "LoggedOnUsers": {
                              "type": "string"
                            },
                            "MdatpDeviceId": {
                              "type": "string"
                            },
                            "OnboardingStatus": {
                              "type": "string"
                            },
                            "RiskScore": {
                              "type": "string"
                            }
                          },
                          "type": "object"
                        },
                        "friendlyName": {
                          "type": "string"
                        },
                        "hostName": {
                          "type": "string"
                        },
                        "osFamily": {
                          "type": "string"
                        },
                        "osVersion": {
                          "type": "string"
                        }
                      },
                      "type": "object"
                    }
                  }
                }
              },
              "runAfter": {
                "Initialize_Endpoint_Filters_array": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Initialize_API_Gateway_Query": {
              "runAfter": {
                "Exit_early_if_no_hosts_are_found": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "api gateway query",
                    "type": "string",
                    "value": "query ($incidentHosts: EndpointFieldFilter, $endCursor: Cursor, $source: EndpointSource) {   endpoints(     source: $source     first: 10     after: $endCursor     filter: $incidentHosts   ) {     edges {       node {         id         name         ipAddress         os { platform generation }         disks {           name           free         }       }     }     pageInfo {       hasNextPage       endCursor     }   } }"
                  }
                ]
              },
              "description": "To check this query against a Tanium Server question use this in the query variables: {\"source\":{\"ts\":{\"stableWaitTime\":10}}}"
            },
            "Initialize_API_Gateway_Query_Variables": {
              "runAfter": {
                "Initialize_Tanium_Endpoint_Source_to_TDS": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "api gateway query variables",
                    "type": "string",
                    "value": "{   \"source\": @{variables('Tanium Endpoint Source')},   \"incidentHosts\": {     \"any\": true,     \"filters\": @{variables('endpoint filters')}   } }"
                  }
                ]
              }
            },
            "Initialize_API_Gateway_Response": {
              "runAfter": {
                "Query_API_Gateway": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "API Gateway Response",
                    "type": "object",
                    "value": "@body('Query_API_Gateway')"
                  }
                ]
              }
            },
            "Initialize_API_Gateway_query_cursor": {
              "runAfter": {
                "Parse_API_Gateway_response": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "cursor",
                    "type": "string",
                    "value": "@body('Parse_API_Gateway_response')?['data']?['endpoints']?['pageInfo']?['endCursor']"
                  }
                ]
              }
            },
            "Initialize_Endpoint_Filters_array": {
              "runAfter": {
                "Initialize_API_Gateway_Query": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "endpoint filters",
                    "type": "array"
                  }
                ]
              }
            },
            "Initialize_Tanium_Endpoint_Source_to_TDS": {
              "runAfter": {
                "For_each_incident_host": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "tanium endpoint source",
                    "type": "object",
                    "value": {
                      "tds": {
                        "allNameSpaces": false
                      }
                    }
                  }
                ]
              }
            },
            "Initialize_endpoints_array": {
              "runAfter": {
                "Initialize_API_Gateway_query_cursor": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "endpoints",
                    "type": "array",
                    "value": "@body('Parse_API_Gateway_response')?['data']?['endpoints']?['edges']"
                  }
                ]
              }
            },
            "Paginate_API_Gateway_query_if_needed": {
              "actions": {
                "Until": {
                  "actions": {
                    "For_each_endpoint_in_paginated_API_Gateway_response": {
                      "foreach": "@body('Parse_paginated_API_Gateway_response')?['data']?['endpoints']?['edges']",
                      "actions": {
                        "Append_endpoint_to_endpoints": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "endpoints",
                            "value": "@items('For_each_endpoint_in_paginated_API_Gateway_response')"
                          }
                        }
                      },
                      "runAfter": {
                        "Update_API_Gateway_query_cursor": [
                          "Succeeded"
                        ]
                      },
                      "type": "Foreach",
                      "runtimeConfiguration": {
                        "concurrency": {
                          "repetitions": 1
                        }
                      }
                    },
                    "Paginate_API_Gateway": {
                      "runAfter": {
                        "Update_API_Gateway_query_variables": [
                          "Succeeded"
                        ]
                      },
                      "type": "Http",
                      "inputs": {
                        "body": {
                          "query": "@variables('api gateway query')",
                          "variables": "@variables('api gateway query variables')"
                        },
                        "headers": {
                          "Content-Type": "application/json",
                          "session": "@parameters('playbook1-TaniumApiToken')"
                        },
                        "method": "POST",
                        "uri": "@parameters('playbook1-TaniumApiGatewayApi')"
                      },
                      "runtimeConfiguration": {
                        "secureData": {
                          "properties": [
                            "inputs"
                          ]
                        }
                      }
                    },
                    "Parse_paginated_API_Gateway_response": {
                      "runAfter": {
                        "Paginate_API_Gateway": [
                          "Succeeded"
                        ]
                      },
                      "type": "ParseJson",
                      "inputs": {
                        "content": "@body('Paginate_API_Gateway')",
                        "schema": {
                          "properties": {
                            "data": {
                              "properties": {
                                "endpoints": {
                                  "properties": {
                                    "edges": {
                                      "items": {
                                        "properties": {
                                          "node": {
                                            "type": "object"
                                          }
                                        },
                                        "required": [
                                          "node"
                                        ],
                                        "type": "object"
                                      },
                                      "type": "array"
                                    },
                                    "pageInfo": {
                                      "properties": {
                                        "endCursor": {
                                          "type": "string"
                                        },
                                        "hasNextPage": {
                                          "type": "boolean"
                                        }
                                      },
                                      "type": "object"
                                    }
                                  },
                                  "type": "object"
                                }
                              },
                              "type": "object"
                            }
                          },
                          "type": "object"
                        }
                      }
                    },
                    "Update_API_Gateway_query_cursor": {
                      "runAfter": {
                        "Parse_paginated_API_Gateway_response": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "cursor",
                        "value": "@body('Parse_paginated_API_Gateway_response')?['data']?['endpoints']?['pageInfo']?['endCursor']"
                      }
                    },
                    "Update_API_Gateway_query_variables": {
                      "type": "SetVariable",
                      "inputs": {
                        "name": "api gateway query variables",
                        "value": "{   \"source\": @{variables('tanium endpoint source')},   \"endCursor\": \"@{variables('cursor')}\" }"
                      }
                    }
                  },
                  "expression": "@equals(body('Parse_paginated_API_Gateway_response')?['data']?['endpoints']?['pageInfo']?['hasNextPage'], false)",
                  "limit": {
                    "count": 60,
                    "timeout": "PT1H"
                  },
                  "type": "Until"
                }
              },
              "runAfter": {
                "Initialize_endpoints_array": [
                  "Succeeded"
                ]
              },
              "expression": {
                "and": [
                  {
                    "equals": [
                      "@body('Parse_API_Gateway_response')?['data']?['endpoints']?['pageInfo']?['hasNextPage']",
                      "@true"
                    ]
                  }
                ]
              },
              "type": "If"
            },
            "Parse_API_Gateway_response": {
              "runAfter": {
                "Switch_to_TS_from_TDS_if_needed": [
                  "Succeeded"
                ]
              },
              "type": "ParseJson",
              "inputs": {
                "content": "@variables('API Gateway Response')",
                "schema": {
                  "properties": {
                    "data": {
                      "properties": {
                        "endpoints": {
                          "properties": {
                            "edges": {
                              "items": {
                                "properties": {
                                  "node": {
                                    "type": "object"
                                  }
                                },
                                "required": [
                                  "node"
                                ],
                                "type": "object"
                              },
                              "type": "array"
                            },
                            "pageInfo": {
                              "properties": {
                                "endCursor": {
                                  "type": "string"
                                },
                                "hasNextPage": {
                                  "type": "boolean"
                                }
                              },
                              "type": "object"
                            }
                          },
                          "type": "object"
                        }
                      },
                      "type": "object"
                    },
                    "errors": {
                      "items": {
                        "properties": {
                          "message": {
                            "type": "string"
                          }
                        },
                        "required": [
                          "message"
                        ],
                        "type": "object"
                      },
                      "type": "array"
                    }
                  },
                  "type": "object"
                }
              }
            },
            "Parse_endpoints_array": {
              "runAfter": {
                "Paginate_API_Gateway_query_if_needed": [
                  "Succeeded"
                ]
              },
              "type": "ParseJson",
              "inputs": {
                "content": "@variables('endpoints')",
                "schema": {
                  "type": "array"
                }
              },
              "description": "We need an action's output to use in the JavaScript code since it can't read from a variable"
            },
            "Query_API_Gateway": {
              "runAfter": {
                "Initialize_API_Gateway_Query_Variables": [
                  "Succeeded"
                ]
              },
              "type": "Http",
              "inputs": {
                "body": {
                  "query": "@variables('api gateway query')",
                  "variables": "@variables('api gateway query variables')"
                },
                "headers": {
                  "Content-Type": "application/json",
                  "session": "@parameters('playbook1-TaniumApiToken')"
                },
                "method": "POST",
                "uri": "@parameters('playbook1-TaniumApiGatewayApi')"
              },
              "runtimeConfiguration": {
                "secureData": {
                  "properties": [
                    "inputs"
                  ]
                }
              }
            },
            "Switch_to_TS_from_TDS_if_needed": {
              "actions": {
                "Requery_the_API_Gateway": {
                  "runAfter": {
                    "Update_API_Query_variables_to_get_new_source": [
                      "Succeeded"
                    ]
                  },
                  "type": "Http",
                  "inputs": {
                    "body": {
                      "query": "@variables('api gateway query')",
                      "variables": "@variables('api gateway query variables')"
                    },
                    "headers": {
                      "Content-Type": "application/json",
                      "session": "@parameters('playbook1-TaniumApiToken')"
                    },
                    "method": "POST",
                    "uri": "@parameters('playbook1-TaniumApiGatewayApi')"
                  },
                  "runtimeConfiguration": {
                    "secureData": {
                      "properties": [
                        "inputs"
                      ]
                    }
                  }
                },
                "Set_Tanium_Endpoint_Source_to_TS": {
                  "type": "SetVariable",
                  "inputs": {
                    "name": "tanium endpoint source",
                    "value": {
                      "ts": {
                        "stableWaitTime": 30
                      }
                    }
                  }
                },
                "Update_API_Gateway_Response": {
                  "runAfter": {
                    "Requery_the_API_Gateway": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "API Gateway Response",
                    "value": "@body('Requery_the_API_Gateway')"
                  }
                },
                "Update_API_Query_variables_to_get_new_source": {
                  "runAfter": {
                    "Set_Tanium_Endpoint_Source_to_TS": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "api gateway query variables",
                    "value": "{   \"source\": @{variables('Tanium Endpoint Source')},   \"incidentHosts\": {     \"any\": true,     \"filters\": @{variables('endpoint filters')}   } }"
                  }
                }
              },
              "runAfter": {
                "Initialize_API_Gateway_Response": [
                  "Succeeded"
                ]
              },
              "expression": {
                "and": [
                  {
                    "contains": [
                      "@string(body('Query_API_Gateway'))",
                      "must refer to an existing sensor"
                    ]
                  }
                ]
              },
              "type": "If"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionName": "[variables('playbook1-AzureSentinelConnectionName')]",
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-AzureSentinelConnectionName'))]",
                "id": "[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',parameters('workspace-location'),'/managedApis/azuresentinel')]"
              }
            }
          },
          "TaniumApiToken": {
            "value": "[parameters('playbook1-TaniumApiToken')]"
          },
          "TaniumApiGatewayApi": {
            "value": "[variables('playbook1-TaniumApiGatewayApi')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Alerts from Tanium Threat Response (THR) that can be acted upon by Microsoft Sentinel Playbook",
        "displayName": "Tanium Threat Response Alerts",
        "enabled": false,
        "query": "let cap = (s:string) { strcat(toupper(substring(s,0,1)), substring(s,1))  };\nTaniumThreatResponse_CL\n| extend TaniumUrl = pack(\"computer_name\", Computer_Name_s, \"alert_guid\", Alert_Id_g, \"ip_address\", Computer_IP_s, \"platform\", Match_Details_finding_system_info_platform_s)\n| extend TaniumTHRLabel = strcat(cap(Intel_Type_s),\" - \", cap(Intel_Name_s), \" - \", cap(Match_Details_match_type_s))\n| where Computer_IP_s !contains \"N/A\"\n",
        "queryFrequency": "PT5M",
        "queryPeriod": "PT6M",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Url",
                "columnName": "TaniumUrl"
              }
            ],
            "entityType": "URL"
          },
          {
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "Computer_IP_s"
              }
            ],
            "entityType": "IP"
          },
          {
            "fieldMappings": [
              {
                "identifier": "HostName",
                "columnName": "Computer_Name_s"
              }
            ],
            "entityType": "Host"
          },
          {
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "TaniumTHRLabel"
              }
            ],
            "entityType": "Malware"
          }
        ]
      }
    },
    {
      "id": "[variables('_connector1-source')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connector1-name'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Tanium Connector",
          "publisher": "Tanium",
          "descriptionMarkdown": "The [Tanium](https://tanium.com) connector allows you to easily connect your Tanium platform to Microsoft Sentinel via [Tanium Connect](https://docs.tanium.com/connect/connect/index.html). This will enable Tanium to send [Tanium Threat Response Alerts](https://docs.tanium.com/threat_response/threat_response/index.html) and other data into the Microsoft Sentinel platform. This gives you insight to better view and control your environment.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "TaniumMainAsset_CL",
              "baseQuery": "TaniumMainAsset_CL"
            }
          ],
          "sampleQueries": [
            {
              "description": "10 Assets sent from Tanium",
              "query": "TaniumMainAsset_CL | limit 10"
            }
          ],
          "dataTypes": [
            {
              "name": "TaniumMainAsset_CL",
              "lastDataReceivedQuery": "TaniumMainAsset_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "TaniumMainAsset_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "description": "If you're using Tanium Cloud, you're already on the latest. If you're using Tanium On-Premises then go to the Solutions page and Import (or Update) the Tanium Connect solution.\n",
              "title": "1. Update Tanium Connect to the latest available version."
            },
            {
              "description": "Contact your Tanium representative to know about importing the required Content Pack. Your representative will either import it for you, or provide it to you via a link.\n",
              "title": "2. Import the required Content Pack."
            },
            {
              "description": "Copy the Workspace ID and Primary Key for your workspace.\n",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "fillWith": [
                      "PrimaryKey"
                    ],
                    "label": "Primary Key"
                  },
                  "type": "CopyableLabel"
                }
              ],
              "title": "3. Get the Workspace ID and the Primary Key"
            },
            {
              "description": " - Go into Tanium Connect->Connections, and click 'New Connection'.\n - Set the source as the 'Sentinel - Main Asset' saved question, and set the Destination to Microsoft Log Analytics.\n - Ensure 'Flatten Results' is not checked on the source fields.\n - Set the Workspace ID and Primary Key in the destination fields.\n - Set the connection to run daily at a time of your choice.\n - Save the connection and enable it.\n",
              "title": "4. Enable Tanium Connect to send the primary asset information into Microsoft Log Analytics."
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "version": "1.0.10",
        "kind": "Solution",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "Tanium",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Tanium",
          "email": "support@tanium.com"
        },
        "support": {
          "name": "Tanium Inc.",
          "email": "support@tanium.com",
          "tier": "Partner",
          "link": "https://support.tanium.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_TaniumWorkbook_workbook')]",
              "version": "1.0.10"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_playbook1-Tanium-GeneralHostInfo')]",
              "version": "1.0.10"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_TaniumThreatResponseAlerts_AnalyticalRules')]",
              "version": "1.0.10"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_TaniumConnectorConnector')]",
              "version": "1.0.10"
            }
          ]
        },
        "firstPublishDate": "2022-05-16",
        "lastPublishDate": "2022-05-16",
        "providers": [
          "Tanium"
        ],
        "categories": {
          "domains": [
            "Security - Network",
            "Security - Threat Protection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
